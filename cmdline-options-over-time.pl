#!/usr/bin/perl

require "./stats/tag2date.pm";

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}


sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        if(num($t) > 801001) {
            push @releases, $t;
        }
    }
}

sub options {
    my @file = @_;

    foreach $f (@file) {
        if($f =~ /ommand line options: *(\d+)/) {
            return $1;
        }
    }
    return 0;
}

sub loc {
    my ($tag) = @_;
    `git checkout -f $tag 2>/dev/null`;
    my @wc = `find lib include src -name "*.[ch]" | xargs wc -l`;
    return int($wc[$#wc]);
}

sub contribs {
    my @file = @_;

    foreach $f (@file) {
        if($f =~ /ontributors: *(\d+)/) {
            return $1;
        }
    }
    return 0;
}

print <<MOO
1997-06-01;2
1997-08-27;9
1998-03-14;21
1998-03-20;24
1998-08-27;29
1999-05-22;46
1999-09-13;48
2000-03-21;48
2000-08-21;48
2000-09-28;52
2000-10-16;52
2000-12-01;54
2001-01-26;54
2001-03-22;58
2001-06-07;58
2001-09-23;62
2002-01-23;70
2002-06-13;76
2002-10-01;79
2003-07-28;89
2004-03-18;94
2004-04-26;94
2004-06-02;96
2004-08-10;96
2004-10-18;96
2004-12-20;100
2005-02-01;104
2005-03-04;104
2005-04-05;106
2005-05-16;107
2005-09-01;108
2005-10-13;109
2005-12-06;109
2006-02-27;112
2006-03-20;112
2006-06-12;112
2006-08-07;114
2006-10-29;112
2007-01-29;115
2007-04-11;118
2007-06-25;118
2007-07-10;118
2007-09-13;118
2007-10-29;121
2008-01-28;126
2008-03-30;126
2008-06-04;126
2008-09-01;127
2008-11-05;128
2008-11-13;128
2009-01-19;128
2009-03-02;132
2009-05-18;132
2009-08-12;132
2009-11-04;132
2010-02-09;136
2010-04-14;136
2010-06-16;138
2010-08-11;138
2010-10-12;138
2010-12-15;143
2011-02-17;143
2011-04-17;143
2011-04-22;144
2011-06-23;144
2011-09-13;149
2011-11-14;149
2011-11-17;149
2012-01-24;149
2012-03-22;151
2012-05-24;151
2012-07-27;152
2012-10-10;152
2012-11-20;152
2013-02-06;152
2013-04-12;152
2013-06-22;152
2013-08-11;152
2013-10-13;161
2013-12-16;161
2014-01-29;161
2014-03-26;161
2014-05-20;161
2014-07-16;162
2014-09-10;162
2014-11-05;162
2015-01-07;162
2015-02-25;163
2015-04-22;173
2015-04-28;173
2015-06-17;176
2015-08-11;176
2015-10-07;177
2015-12-01;177
2016-01-27;179
2016-02-08;179
2016-03-23;179
2016-05-17;185
2016-05-30;185
2016-07-21;185
2016-08-03;185
2016-09-07;185
2016-09-14;185
2016-11-02;185
2016-12-20;204
2016-12-22;204
2017-02-22;205
2017-02-24;205
2017-04-19;207
2017-06-14;207
2017-08-09;210
2017-08-13;210
2017-10-04;211
2017-10-23;211
2017-11-29;211
2018-01-23;211
2018-03-13;213
2018-05-15;214
2018-07-11;218
2018-09-04;218
2018-10-30;219
2018-12-12;219
2019-02-06;220
2019-03-27;221
2019-05-22;221
2019-06-04;221
2019-07-17;221
2019-07-19;221
2019-09-10;225
2019-11-05;226
2020-01-08;229
2020-03-04;230
2020-03-11;230
2020-04-29;231
2020-06-23;232
2020-06-30;232
2020-08-19;232
2020-10-14;234
2020-12-09;235
2021-02-03;237
2021-03-31;240
2021-04-14;240
2021-05-26;242
2021-07-21;242
2021-09-14;242
2021-09-22;242
2021-11-10;243
2022-01-05;244
2022-03-05;245
2022-04-27;247
2022-05-11;247
2022-06-27;248
2022-08-31;248
2022-10-26;248
2022-12-21;249
2023-02-15;250
2023-02-20;250
2023-03-20;250
2023-03-20;250
2023-05-17;251
2023-05-23;251
2023-05-30;251
2023-07-19;255
2023-07-26;255
2023-09-13;257
2023-10-11;258
2023-12-06;258
2024-01-31;258
2024-03-27;258
2024-03-27;258
2024-05-22;259
2024-07-24;263
2024-07-31;263
2024-09-11;265
2024-09-18;265
MOO
    ;

foreach my $t (sort sortthem @releases) {
    my $d = tag2date($t);
    my @out = `git show $t:RELEASE-NOTES 2>/dev/null`;
    my $n = options(@out);
#    my $c = contribs(@out);
#    my $loc = loc($t);

    if($n) {
        # prettyfy
        $t =~ s/_/./g;
        $t =~ s/-/ /g;
        print "$d;$n\n";
    }
}

my $current = 0 + `grep -E '^  {"... --' src/tool_listhelp.c | wc -l`;

if($current) {
    my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
        localtime(time);
    $date = sprintf "%04d-%02d-%02d", $year + 1900, $mon + 1, $mday;
    print "$date;$current\n";
}
