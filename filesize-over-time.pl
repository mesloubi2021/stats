#!/usr/bin/perl

require "./stats/tag2date.pm";

sub median {
    my @a = @_;
    my @vals = sort {$a <=> $b} @a;
    my $len = @vals;
    if($len%2) { #odd?
        return $vals[int($len/2)];
    }
    else {
        #even
        return ($vals[int($len/2)-1] + $vals[int($len/2)])/2;
    }
}

sub num {
    my ($t)=@_;
    if($t =~ /^curl-(\d)_(\d+)_(\d+)/) {
        return 10000*$1 + 100*$2 + $3;
    }
    elsif($t =~ /^curl-(\d)_(\d+)/) {
        return 10000*$1 + 100*$2;
    }
}


sub sortthem {
    return num($a) <=> num($b);
}

@alltags= `git tag -l`;

foreach my $t (@alltags) {
    chomp $t;
    if($t =~ /^curl-([0-9_]*[0-9])\z/) {
        push @releases, $t;
    }
}

sub linesperfile {
    my ($tag, $path) = @_;

    # Get source files to count
    my @files;
    open(G, "git ls-tree -r --name-only $tag -- $path 2>/dev/null|");
    while(<G>) {
        chomp;
        if($_ =~ /\.c\z/) {
            push @files, $_;
        }
    }
    close(G);

    my $lines;
    my @linesperfile;
    my $index = 0;
    for my $f (@files) {
        open(G, "git show $tag:$f 2>/dev/null|");
        while(<G>) {
            $lines++;
            $linesperfile[$index]++;
        }
        close(G);
        $index++;
    }

    return ($lines / scalar(@files)), median(@linesperfile);
}

print <<CACHE
2000-03-14;444.50;206;969.00;1256
2000-03-21;442.50;208;972.00;1265
2000-03-21;442.50;208;993.67;1265
2000-08-21;430.48;190;1116.00;1441
2000-08-30;433.00;191;1139.33;1456
2000-09-28;456.90;195;1163.67;1512
2000-10-16;439.70;200;942.00;940
2000-12-04;444.79;216;990.75;964
2001-01-05;434.36;216;1024.50;1046
2001-01-27;451.84;217;866.00;465
2001-02-13;466.78;217;867.33;465
2001-03-22;492.30;221;871.67;465
2001-04-04;494.79;221;871.67;465
2001-04-23;498.27;221;872.00;465
2001-05-07;504.00;221;872.00;465
2001-06-07;500.12;220;874.00;465
2001-08-20;501.56;240;928.33;465
2001-09-25;545.44;248;946.00;465
2001-11-04;555.83;270;1033.67;465
2001-12-05;558.25;289;1042.67;468
2002-01-23;561.34;277;1064.00;468
2002-02-05;562.76;277;1063.33;468
2002-03-07;565.95;277;1074.67;472
2002-04-15;570.13;275;856.75;344
2002-05-13;580.24;289;891.00;347
2002-06-13;589.45;289;899.75;349
2002-10-01;586.52;264;943.50;350
2002-10-11;588.73;264;943.50;350
2002-11-18;605.56;270;957.75;350
2003-01-14;612.21;276;985.00;350
2003-04-02;573.87;255;996.25;350
2003-05-19;587.37;263;1004.50;350
2003-07-28;577.14;273;1071.75;361
2003-08-15;596.74;281;1085.75;366
2003-11-01;612.17;309;948.00;228
2004-01-22;594.48;287;805.67;230
2004-03-18;597.41;292;814.83;231
2004-04-26;614.35;307;827.50;231
2004-06-02;576.09;330;834.83;230
2004-08-10;584.96;332;840.33;235
2004-10-18;591.07;340;844.17;235
2004-12-20;595.65;332;896.00;246
2005-02-01;599.58;332;905.17;236
2005-03-04;622.78;327;905.83;236
2005-04-05;627.05;327;910.17;236
2005-05-16;620.33;352;934.67;236
2005-09-01;628.58;352;946.33;236
2005-10-13;632.16;375;948.83;238
2005-12-06;636.67;375;961.33;238
2006-02-27;643.12;375;969.00;238
2006-03-20;643.40;375;969.67;238
2006-06-12;669.66;397;989.33;243
2006-08-07;664.43;373;973.17;243
2006-10-29;672.25;389;975.33;243
2007-01-29;690.53;398;1013.83;243
2007-04-11;708.03;416;902.43;216
2007-06-25;725.37;425;907.86;226
2007-07-10;722.58;420;912.86;255
2007-09-13;713.61;420;915.57;257
2007-10-29;732.11;420;920.43;257
2008-01-28;743.00;421;959.00;257
2008-03-30;745.92;421;959.00;257
2008-06-04;752.79;423;963.57;268
2008-09-01;761.27;427;983.00;268
2008-11-05;756.40;421;987.43;268
2008-11-13;755.04;421;987.43;268
2009-01-19;756.96;422;988.43;268
2009-03-02;753.35;423;995.71;268
2009-05-18;747.92;425;997.14;268
2009-08-12;742.51;423;896.75;201
2009-11-04;730.31;420;904.00;201
2010-02-09;736.02;427;941.00;245
2010-04-14;734.43;424;944.25;244
2010-06-16;713.91;422;963.12;244
2010-08-11;705.13;419;969.88;244
2010-10-12;703.94;407;973.75;244
2010-12-15;707.29;406;877.33;221
2011-02-17;698.23;400;882.78;221
2011-04-17;692.83;415;884.00;221
2011-04-22;687.12;402;885.00;221
2011-06-23;686.97;395;889.33;221
2011-09-13;667.46;394;898.22;221
2011-11-14;672.68;394;250.81;135
2011-11-17;672.68;394;250.76;135
2012-01-24;682.36;407;251.16;138
2012-03-22;683.79;407;270.44;151
2012-05-24;689.32;424;270.81;149
2012-07-27;697.02;435;288.43;150
2012-10-10;704.33;435;291.89;150
2012-11-20;700.97;431;295.62;150
2013-02-06;686.53;431;297.49;150
2013-04-12;688.87;413;297.35;150
2013-06-22;699.02;413;300.27;150
2013-08-11;709.56;431;304.62;150
2013-10-13;714.90;413;307.78;150
2013-12-16;720.95;413;309.22;150
2014-01-29;725.25;413;309.22;151
2014-03-26;738.04;431;314.81;153
2014-05-20;739.03;427;316.35;154
2014-07-16;743.45;427;318.41;154
2014-09-10;758.48;435;318.41;154
2014-11-05;762.97;435;311.55;153
2015-01-07;768.12;427;312.32;154
2015-02-25;750.63;413;312.63;154
2015-04-22;750.77;410;314.18;158
2015-04-28;750.77;410;314.32;158
2015-06-17;763.45;431;315.03;159
2015-08-11;767.06;431;315.13;159
2015-10-07;767.45;431;317.74;160
2015-12-01;769.89;432;311.74;159
2016-01-27;772.10;432;315.36;159
2016-02-08;772.15;432;322.28;159
2016-03-23;774.56;432;322.69;159
2016-05-17;740.01;414;323.49;159
2016-05-30;735.33;402;323.49;159
2016-07-21;737.50;418;324.05;159
2016-08-03;737.61;418;324.05;159
2016-09-07;741.20;418;324.18;159
2016-09-14;741.32;418;324.51;159
2016-11-02;746.87;426;324.77;159
2016-12-20;752.02;426;331.69;159
2016-12-22;752.02;426;331.69;159
2017-02-22;755.02;426;333.26;159
2017-02-24;755.10;426;333.59;159
2017-04-19;758.14;422;335.08;159
2017-06-14;760.57;410;345.55;166
2017-08-09;760.79;403;348.66;175
2017-08-13;761.58;403;348.66;175
2017-10-04;777.46;413;369.27;177
2017-10-23;780.14;413;372.38;177
2017-11-29;776.52;437;372.95;177
2018-01-23;788.36;440;376.05;190
2018-03-13;780.68;414;368.79;183
2018-05-15;782.68;425;370.03;183
2018-07-11;780.09;414;371.74;184
2018-09-04;781.56;414;373.24;184
2018-10-30;783.88;456;374.95;184
2018-12-12;786.57;448;377.97;202
2019-02-06;789.79;448;379.76;201
2019-03-27;789.94;463;383.00;204
2019-05-22;786.36;489;383.16;203
2019-06-04;786.88;489;384.58;203
2019-07-17;786.81;489;385.89;203
2019-07-19;786.73;489;385.89;203
2019-09-10;796.62;503;392.28;218
2019-11-05;792.62;498;394.90;218
2020-01-08;795.83;503;400.38;218
2020-03-04;799.34;500;400.31;218
2020-03-11;801.17;500;400.31;218
2020-04-29;803.43;508;395.50;207
2020-06-23;794.76;504;398.40;207
2020-06-30;794.94;504;398.40;207
2020-08-19;792.09;508;399.02;207
2020-10-14;788.59;481;408.40;210
2020-12-09;786.77;494;409.02;210
2021-02-03;789.99;489;410.65;210
2021-03-31;785.28;487;408.57;207
2021-04-14;785.69;487;408.77;207
2021-05-26;785.78;479;410.95;207
2021-07-21;788.99;474;394.56;196
2021-09-14;791.53;472;396.31;196
2021-09-22;791.63;472;396.31;196
2021-11-10;796.49;472;387.18;207
2022-01-05;801.07;472;388.73;207
2022-03-05;807.91;472;394.10;218
2022-04-27;801.02;449;397.82;218
2022-05-11;801.86;449;398.03;218
2022-06-27;803.99;429;401.62;220
2022-08-31;810.12;429;403.36;220
2022-10-26;817.24;482;404.90;220
2022-12-21;823.16;491;415.45;211
2023-02-15;832.16;482;419.05;219
2023-02-20;832.50;482;419.18;219
2023-03-20;840.44;491;410.13;219
2023-03-20;840.36;491;410.13;219
2023-05-17;841.41;500;414.38;219
2023-05-23;841.55;500;414.38;219
2023-05-30;841.33;500;415.03;219
2023-07-19;841.04;491;417.51;219
2023-07-26;841.10;491;417.51;219
2023-09-13;833.91;478;427.60;219
2023-10-11;834.90;490;432.05;219
2023-12-06;839.43;491;424.88;220
2024-01-31;844.88;487;426.59;235
2024-03-27;842.23;500;429.61;238
2024-03-27;842.23;500;429.61;238
2024-05-22;849.78;474;432.37;238
CACHE
    ;

sub show {
    my ($t, $d) = @_;
    my ($srclines, $srcmedian) = linesperfile($t, "src");
    my ($liblines, $libmedian) = linesperfile($t, "lib");
    printf "$d;%.2f;%u;%.2f;%u\n", $liblines, $libmedian,
        $srclines, $srcmedian;
}

foreach my $t (sort sortthem @releases) {
    if(num($t) <= 80800) {
        next;
    }
    my $d = tag2date($t);
    show($t, $d);
}

$t=`git describe`;
chomp $t;

my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
    localtime(time);
my $d = sprintf "%04d-%02d-%02d", $year + 1900, $mon + 1, $mday;

show($t, $d);
